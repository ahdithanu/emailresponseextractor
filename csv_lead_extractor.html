<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Follow-Up Leads Extractor</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #7f8c8d;
            font-size: 16px;
        }
        .upload-area {
            border: 3px dashed #3498db;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            border-color: #2980b9;
            background: #e3f2fd;
        }
        .upload-area.dragover {
            border-color: #27ae60;
            background: #e8f5e8;
        }
        input[type="file"] {
            margin: 20px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 100%;
            max-width: 400px;
        }
        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: all 0.3s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .results {
            margin-top: 30px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .table-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 20px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        tr:hover {
            background: #f8f9fa;
        }
        .export-section {
            margin-top: 30px;
            text-align: center;
        }
        .progress {
            width: 100%;
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2980b9);
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìß Follow-Up Leads Extractor</h1>
            <p class="subtitle">Extract contact information from email campaign responses</p>
        </div>
        
        <div class="upload-area" id="uploadArea">
            <h3>üìÅ Upload Your CSV Files</h3>
            <p>Drop CSV files here or click to select</p>
            <input type="file" id="fileInput" accept=".csv" multiple>
            <button class="btn" onclick="document.getElementById('fileInput').click()">Choose Files</button>
        </div>
        
        <div class="progress" id="progressContainer" style="display: none;">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        
        <div id="results" class="results" style="display: none;">
            <h2>üìä Extraction Results</h2>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalFiles">0</div>
                    <div>Files Processed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalRecords">0</div>
                    <div>Total Records</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalResponses">0</div>
                    <div>Total Responses</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="followUpLeads">0</div>
                    <div>Follow-Up Leads</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="phoneNumbers">0</div>
                    <div>Phone Numbers Found</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="excludedCount">0</div>
                    <div>Excluded (Don't Contact)</div>
                </div>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>First Name</th>
                            <th>Last Name</th>
                            <th>Company</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Source File</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTable">
                    </tbody>
                </table>
            </div>
            
            <div class="export-section">
                <button class="btn" id="exportCSV">üì• Export to CSV</button>
                <button class="btn" id="exportExcel">üìä Export to Excel Format</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script>
        let extractedLeads = [];
        let stats = {
            totalFiles: 0,
            totalRecords: 0,
            totalResponses: 0,
            followUpLeads: 0,
            phoneNumbers: 0,
            excludedCount: 0
        };

        // File upload handling
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            processFiles(files);
        });

        fileInput.addEventListener('change', (e) => {
            processFiles(e.target.files);
        });

        // Check if someone said don't contact
        function isDontContact(replyMessage) {
            if (!replyMessage) return false;
            const message = replyMessage.toString().toLowerCase();
            const dontContactKeywords = [
                'don\'t contact', 'do not contact', 'don\'t call', 'do not call',
                'don\'t email', 'do not email', 'remove me', 'unsubscribe',
                'stop contacting', 'stop calling', 'stop emailing', 'not interested',
                'leave me alone', 'don\'t reach out', 'do not reach out', 'opt out',
                'take me off', 'remove from list'
            ];
            return dontContactKeywords.some(keyword => message.includes(keyword));
        }

        // Extract contact info
        function extractContactInfo(leadName, leadEmail, replyMessage, sourceFile) {
            const nameParts = leadName ? leadName.trim().split(' ') : ['', ''];
            const firstName = nameParts[0] || '';
            const lastName = nameParts.slice(1).join(' ') || '';
            
            // Extract company from email domain
            let company = '';
            if (leadEmail && leadEmail.includes('@')) {
                const domain = leadEmail.split('@')[1];
                if (domain) {
                    const domainParts = domain.split('.');
                    company = domainParts[0];
                    company = company.replace(/^(www|mail|email)/, '').trim();
                    if (company) {
                        company = company.charAt(0).toUpperCase() + company.slice(1);
                    }
                }
            }
            
            // Extract phone number
            let phone = '';
            if (replyMessage) {
                const phonePattern = /\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}/g;
                const matches = replyMessage.toString().match(phonePattern);
                if (matches && matches[0] && matches[0].length >= 10) {
                    phone = matches[0];
                }
            }
            
            return {
                firstName,
                lastName,
                company,
                email: leadEmail || '',
                phone: phone || '',
                sourceFile
            };
        }

        // Process uploaded files
        async function processFiles(files) {
            extractedLeads = [];
            stats = {
                totalFiles: 0,
                totalRecords: 0,
                totalResponses: 0,
                followUpLeads: 0,
                phoneNumbers: 0,
                excludedCount: 0
            };

            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            progressContainer.style.display = 'block';

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const progress = ((i + 1) / files.length) * 100;
                progressBar.style.width = progress + '%';

                await processFile(file);
            }

            displayResults();
            progressContainer.style.display = 'none';
        }

        // Process individual file
        function processFile(file) {
            return new Promise((resolve) => {
                Papa.parse(file, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        stats.totalFiles++;
                        stats.totalRecords += results.data.length;

                        results.data.forEach(row => {
                            const replyMessage = row['Reply Message'];
                            if (replyMessage && replyMessage.toString().trim() !== '') {
                                stats.totalResponses++;

                                if (isDontContact(replyMessage)) {
                                    stats.excludedCount++;
                                } else {
                                    const contactInfo = extractContactInfo(
                                        row['Lead Name'],
                                        row['Lead Email'],
                                        replyMessage,
                                        file.name
                                    );
                                    
                                    extractedLeads.push(contactInfo);
                                    stats.followUpLeads++;
                                    
                                    if (contactInfo.phone) {
                                        stats.phoneNumbers++;
                                    }
                                }
                            }
                        });
                        resolve();
                    }
                });
            });
        }

        // Display results
        function displayResults() {
            document.getElementById('results').style.display = 'block';
            
            // Update stats
            document.getElementById('totalFiles').textContent = stats.totalFiles;
            document.getElementById('totalRecords').textContent = stats.totalRecords.toLocaleString();
            document.getElementById('totalResponses').textContent = stats.totalResponses.toLocaleString();
            document.getElementById('followUpLeads').textContent = stats.followUpLeads.toLocaleString();
            document.getElementById('phoneNumbers').textContent = stats.phoneNumbers.toLocaleString();
            document.getElementById('excludedCount').textContent = stats.excludedCount.toLocaleString();
            
            // Populate table
            const tbody = document.getElementById('resultsTable');
            tbody.innerHTML = '';
            
            extractedLeads.forEach(lead => {
                const row = tbody.insertRow();
                row.insertCell(0).textContent = lead.firstName;
                row.insertCell(1).textContent = lead.lastName;
                row.insertCell(2).textContent = lead.company;
                row.insertCell(3).textContent = lead.email;
                row.insertCell(4).textContent = lead.phone;
                row.insertCell(5).textContent = lead.sourceFile;
            });
        }

        // Export functions
        document.getElementById('exportCSV').addEventListener('click', () => {
            const csv = Papa.unparse(extractedLeads);
            downloadFile(csv, 'follow_up_leads.csv', 'text/csv');
        });

        document.getElementById('exportExcel').addEventListener('click', () => {
            const csv = Papa.unparse(extractedLeads);
            downloadFile(csv, 'follow_up_leads.csv', 'application/vnd.ms-excel');
        });

        function downloadFile(content, fileName, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>